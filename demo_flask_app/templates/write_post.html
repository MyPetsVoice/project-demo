{% extends "base.html" %}

{% block title %}새 글 작성 - PetCare{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0"><i class="fas fa-edit"></i> 새 글 작성</h3>
                <p class="mb-0">반려동물과 관련된 다양한 이야기를 공유해보세요!</p>
            </div>
            
            <div class="card-body">
                <form id="postForm">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="title" class="form-label">제목 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" required
                                   placeholder="게시글 제목을 입력하세요" maxlength="100">
                            <div class="form-text">제목은 100자 이내로 작성해주세요</div>
                        </div>
                        <div class="col-md-4">
                            <label for="tag" class="form-label">태그</label>
                            <select class="form-select" id="tag" name="tag">
                                <option value="">태그 선택</option>
                                <option value="산책해요">🚶‍♀️ 산책해요</option>
                                <option value="꿀팁">💡 꿀팁</option>
                                <option value="질문">❓ 질문</option>
                                <option value="자랑">🏆 자랑</option>
                                <option value="병원">🏥 병원</option>
                                <option value="훈련">🎾 훈련</option>
                                <option value="간식">🦴 간식</option>
                                <option value="용품">🛍️ 용품</option>
                                <option value="입양">🏠 입양</option>
                                <option value="기타">📝 기타</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="content" class="form-label">내용 <span class="text-danger">*</span></label>
                        <div class="position-relative">
                            <textarea class="form-control" id="content" name="content" rows="12" required
                                      placeholder="반려동물과 관련된 이야기, 질문, 팁 등을 자유롭게 작성해주세요.

예시:
- 우리 강아지가 산책을 싫어해요. 어떻게 하면 좋을까요?
- 고양이 털 관리 꿀팁을 공유드려요!
- 오늘 우리 햄스터가 새로운 재주를 배웠어요 🐹
- 반려동물 용품 추천 부탁드려요

서로 도움이 되는 정보를 나누어요! 😊"></textarea>
                            <div class="position-absolute bottom-0 end-0 p-2">
                                <small class="text-muted" id="charCount">0/2000</small>
                            </div>
                        </div>
                        <div class="form-text">최대 2000자까지 작성 가능합니다</div>
                    </div>

                    <div class="mb-4">
                        <label for="images" class="form-label">사진 첨부</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">최대 5장까지 업로드 가능합니다 (각 파일 최대 5MB)</div>
                        <div id="imagePreview" class="mt-3 d-none">
                            <div class="row" id="imageContainer"></div>
                        </div>
                    </div>

                    <!-- 작성 팁 -->
                    <div class="alert alert-light" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-lightbulb text-warning"></i> 작성 팁</h6>
                        <ul class="mb-0 small">
                            <li>구체적이고 명확한 제목을 작성하면 더 많은 관심을 받을 수 있어요</li>
                            <li>사진을 함께 올리면 게시글이 더욱 생동감 있어져요</li>
                            <li>질문글인 경우 상황을 자세히 설명해주세요</li>
                            <li>서로를 존중하는 따뜻한 커뮤니티를 만들어가요</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('community') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 취소
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="previewPost()">
                                <i class="fas fa-eye"></i> 미리보기
                            </button>
                            <button type="submit" class="btn btn-info">
                                <i class="fas fa-paper-plane"></i> 게시하기
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 커뮤니티 규칙 -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-shield-alt text-success"></i> 커뮤니티 규칙</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">✅ 지켜주세요</h6>
                        <ul class="small">
                            <li>반려동물과 관련된 내용</li>
                            <li>서로 존중하는 언어 사용</li>
                            <li>도움이 되는 정보 공유</li>
                            <li>정확한 정보 전달</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">❌ 금지사항</h6>
                        <ul class="small">
                            <li>욕설, 비방, 혐오 표현</li>
                            <li>상업적 광고 및 홍보</li>
                            <li>개인정보 노출</li>
                            <li>허위 정보 유포</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 미리보기 모달 -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> 게시글 미리보기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- 미리보기 내용이 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-info" onclick="submitPost()">
                    <i class="fas fa-paper-plane"></i> 게시하기
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 글자 수 카운터
document.getElementById('content').addEventListener('input', function() {
    const charCount = this.value.length;
    const counter = document.getElementById('charCount');
    counter.textContent = `${charCount}/2000`;
    
    if (charCount > 2000) {
        counter.classList.add('text-danger');
        this.value = this.value.substring(0, 2000);
    } else {
        counter.classList.remove('text-danger');
    }
});

// 이미지 업로드 미리보기
document.getElementById('images').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const container = document.getElementById('imageContainer');
    const preview = document.getElementById('imagePreview');
    
    container.innerHTML = '';
    
    if (files.length > 0) {
        preview.classList.remove('d-none');
        
        files.slice(0, 5).forEach((file, index) => {
            // 파일 크기 체크 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert(`${file.name} 파일이 너무 큽니다. 5MB 이하의 파일을 선택해주세요.`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-md-2 col-4 mb-2';
                col.innerHTML = `
                    <div class="position-relative">
                        <img src="${e.target.result}" class="img-fluid rounded" 
                             style="height: 100px; object-fit: cover; width: 100%;">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" 
                                onclick="removeImage(${index})" style="width: 25px; height: 25px; font-size: 12px;">
                            ×
                        </button>
                    </div>
                `;
                container.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    } else {
        preview.classList.add('d-none');
    }
});

// 폼 제출
document.getElementById('postForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        if (key !== 'images') {
            data[key] = value;
        }
    }
    
    // 유효성 검사
    if (!data.title.trim()) {
        alert('제목을 입력해주세요.');
        return;
    }
    
    if (!data.content.trim()) {
        alert('내용을 입력해주세요.');
        return;
    }
    
    if (data.content.length > 2000) {
        alert('내용이 너무 깁니다. 2000자 이내로 작성해주세요.');
        return;
    }
    
    try {
        const response = await fetch('/community/write', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            window.location.href = result.redirect;
        } else {
            alert(result.error || '게시글 작성 중 오류가 발생했습니다.');
        }
    } catch (error) {
        alert('게시글 작성 중 오류가 발생했습니다.');
        console.error('Error:', error);
    }
});

function previewPost() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;
    const tag = document.getElementById('tag').value;
    
    if (!title.trim() || !content.trim()) {
        alert('제목과 내용을 입력해주세요.');
        return;
    }
    
    const previewContent = document.getElementById('previewContent');
    const now = new Date().toLocaleString('ko-KR');
    
    previewContent.innerHTML = `
        <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3" 
                     style="width: 40px; height: 40px;">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <h6 class="mb-0">{{ current_user.nickname }}</h6>
                    <small class="text-muted">${now}</small>
                </div>
            </div>
            ${tag ? `<span class="badge bg-secondary">${tag}</span>` : ''}
        </div>
        
        <h5 class="mb-3">${title}</h5>
        
        <div style="white-space: pre-wrap; line-height: 1.6;">
            ${content}
        </div>
        
        <hr class="my-4">
        
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex gap-3">
                <span class="text-muted"><i class="far fa-heart"></i> 0</span>
                <span class="text-muted"><i class="fas fa-comment"></i> 0</span>
                <span class="text-muted"><i class="fas fa-eye"></i> 0</span>
            </div>
            <small class="text-muted">게시 후 수정이 가능합니다</small>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

function submitPost() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
    modal.hide();
    
    setTimeout(() => {
        document.getElementById('postForm').dispatchEvent(new Event('submit'));
    }, 300);
}

function removeImage(index) {
    // 이미지 제거 기능 (추후 구현)
    alert('이미지 제거 기능은 추후 구현 예정입니다.');
}

// 페이지 이탈 방지
window.addEventListener('beforeunload', function(e) {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;
    
    if (title.trim() || content.trim()) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}