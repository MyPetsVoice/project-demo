{% extends "base.html" %}

{% block title %}ìƒˆ ê¸€ ì‘ì„± - PetCare{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0"><i class="fas fa-edit"></i> ìƒˆ ê¸€ ì‘ì„±</h3>
                <p class="mb-0">ë°˜ë ¤ë™ë¬¼ê³¼ ê´€ë ¨ëœ ë‹¤ì–‘í•œ ì´ì•¼ê¸°ë¥¼ ê³µìœ í•´ë³´ì„¸ìš”!</p>
            </div>
            
            <div class="card-body">
                <form id="postForm">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="title" class="form-label">ì œëª© <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" required
                                   placeholder="ê²Œì‹œê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100">
                            <div class="form-text">ì œëª©ì€ 100ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”</div>
                        </div>
                        <div class="col-md-4">
                            <label for="tag" class="form-label">íƒœê·¸</label>
                            <select class="form-select" id="tag" name="tag">
                                <option value="">íƒœê·¸ ì„ íƒ</option>
                                <option value="ì‚°ì±…í•´ìš”">ğŸš¶â€â™€ï¸ ì‚°ì±…í•´ìš”</option>
                                <option value="ê¿€íŒ">ğŸ’¡ ê¿€íŒ</option>
                                <option value="ì§ˆë¬¸">â“ ì§ˆë¬¸</option>
                                <option value="ìë‘">ğŸ† ìë‘</option>
                                <option value="ë³‘ì›">ğŸ¥ ë³‘ì›</option>
                                <option value="í›ˆë ¨">ğŸ¾ í›ˆë ¨</option>
                                <option value="ê°„ì‹">ğŸ¦´ ê°„ì‹</option>
                                <option value="ìš©í’ˆ">ğŸ›ï¸ ìš©í’ˆ</option>
                                <option value="ì…ì–‘">ğŸ  ì…ì–‘</option>
                                <option value="ê¸°íƒ€">ğŸ“ ê¸°íƒ€</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="content" class="form-label">ë‚´ìš© <span class="text-danger">*</span></label>
                        <div class="position-relative">
                            <textarea class="form-control" id="content" name="content" rows="12" required
                                      placeholder="ë°˜ë ¤ë™ë¬¼ê³¼ ê´€ë ¨ëœ ì´ì•¼ê¸°, ì§ˆë¬¸, íŒ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
- ìš°ë¦¬ ê°•ì•„ì§€ê°€ ì‚°ì±…ì„ ì‹«ì–´í•´ìš”. ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œìš”?
- ê³ ì–‘ì´ í„¸ ê´€ë¦¬ ê¿€íŒì„ ê³µìœ ë“œë ¤ìš”!
- ì˜¤ëŠ˜ ìš°ë¦¬ í–„ìŠ¤í„°ê°€ ìƒˆë¡œìš´ ì¬ì£¼ë¥¼ ë°°ì› ì–´ìš” ğŸ¹
- ë°˜ë ¤ë™ë¬¼ ìš©í’ˆ ì¶”ì²œ ë¶€íƒë“œë ¤ìš”

ì„œë¡œ ë„ì›€ì´ ë˜ëŠ” ì •ë³´ë¥¼ ë‚˜ëˆ„ì–´ìš”! ğŸ˜Š"></textarea>
                            <div class="position-absolute bottom-0 end-0 p-2">
                                <small class="text-muted" id="charCount">0/2000</small>
                            </div>
                        </div>
                        <div class="form-text">ìµœëŒ€ 2000ìê¹Œì§€ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
                    </div>

                    <div class="mb-4">
                        <label for="images" class="form-label">ì‚¬ì§„ ì²¨ë¶€</label>
                        <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                        <div class="form-text">ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤ (ê° íŒŒì¼ ìµœëŒ€ 5MB)</div>
                        <div id="imagePreview" class="mt-3 d-none">
                            <div class="row" id="imageContainer"></div>
                        </div>
                    </div>

                    <!-- ì‘ì„± íŒ -->
                    <div class="alert alert-light" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-lightbulb text-warning"></i> ì‘ì„± íŒ</h6>
                        <ul class="mb-0 small">
                            <li>êµ¬ì²´ì ì´ê³  ëª…í™•í•œ ì œëª©ì„ ì‘ì„±í•˜ë©´ ë” ë§ì€ ê´€ì‹¬ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”</li>
                            <li>ì‚¬ì§„ì„ í•¨ê»˜ ì˜¬ë¦¬ë©´ ê²Œì‹œê¸€ì´ ë”ìš± ìƒë™ê° ìˆì–´ì ¸ìš”</li>
                            <li>ì§ˆë¬¸ê¸€ì¸ ê²½ìš° ìƒí™©ì„ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”</li>
                            <li>ì„œë¡œë¥¼ ì¡´ì¤‘í•˜ëŠ” ë”°ëœ»í•œ ì»¤ë®¤ë‹ˆí‹°ë¥¼ ë§Œë“¤ì–´ê°€ìš”</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('community') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> ì·¨ì†Œ
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="previewPost()">
                                <i class="fas fa-eye"></i> ë¯¸ë¦¬ë³´ê¸°
                            </button>
                            <button type="submit" class="btn btn-info">
                                <i class="fas fa-paper-plane"></i> ê²Œì‹œí•˜ê¸°
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ì»¤ë®¤ë‹ˆí‹° ê·œì¹™ -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-shield-alt text-success"></i> ì»¤ë®¤ë‹ˆí‹° ê·œì¹™</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">âœ… ì§€ì¼œì£¼ì„¸ìš”</h6>
                        <ul class="small">
                            <li>ë°˜ë ¤ë™ë¬¼ê³¼ ê´€ë ¨ëœ ë‚´ìš©</li>
                            <li>ì„œë¡œ ì¡´ì¤‘í•˜ëŠ” ì–¸ì–´ ì‚¬ìš©</li>
                            <li>ë„ì›€ì´ ë˜ëŠ” ì •ë³´ ê³µìœ </li>
                            <li>ì •í™•í•œ ì •ë³´ ì „ë‹¬</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">âŒ ê¸ˆì§€ì‚¬í•­</h6>
                        <ul class="small">
                            <li>ìš•ì„¤, ë¹„ë°©, í˜ì˜¤ í‘œí˜„</li>
                            <li>ìƒì—…ì  ê´‘ê³  ë° í™ë³´</li>
                            <li>ê°œì¸ì •ë³´ ë…¸ì¶œ</li>
                            <li>í—ˆìœ„ ì •ë³´ ìœ í¬</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> ê²Œì‹œê¸€ ë¯¸ë¦¬ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-info" onclick="submitPost()">
                    <i class="fas fa-paper-plane"></i> ê²Œì‹œí•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ê¸€ì ìˆ˜ ì¹´ìš´í„°
document.getElementById('content').addEventListener('input', function() {
    const charCount = this.value.length;
    const counter = document.getElementById('charCount');
    counter.textContent = `${charCount}/2000`;
    
    if (charCount > 2000) {
        counter.classList.add('text-danger');
        this.value = this.value.substring(0, 2000);
    } else {
        counter.classList.remove('text-danger');
    }
});

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°
document.getElementById('images').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const container = document.getElementById('imageContainer');
    const preview = document.getElementById('imagePreview');
    
    container.innerHTML = '';
    
    if (files.length > 0) {
        preview.classList.remove('d-none');
        
        files.slice(0, 5).forEach((file, index) => {
            // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert(`${file.name} íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 5MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-md-2 col-4 mb-2';
                col.innerHTML = `
                    <div class="position-relative">
                        <img src="${e.target.result}" class="img-fluid rounded" 
                             style="height: 100px; object-fit: cover; width: 100%;">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" 
                                onclick="removeImage(${index})" style="width: 25px; height: 25px; font-size: 12px;">
                            Ã—
                        </button>
                    </div>
                `;
                container.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    } else {
        preview.classList.add('d-none');
    }
});

// í¼ ì œì¶œ
document.getElementById('postForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        if (key !== 'images') {
            data[key] = value;
        }
    }
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!data.title.trim()) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!data.content.trim()) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (data.content.length > 2000) {
        alert('ë‚´ìš©ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤. 2000ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const response = await fetch('/community/write', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            window.location.href = result.redirect;
        } else {
            alert(result.error || 'ê²Œì‹œê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        alert('ê²Œì‹œê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error('Error:', error);
    }
});

function previewPost() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;
    const tag = document.getElementById('tag').value;
    
    if (!title.trim() || !content.trim()) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const previewContent = document.getElementById('previewContent');
    const now = new Date().toLocaleString('ko-KR');
    
    previewContent.innerHTML = `
        <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-info rounded-circle d-flex align-items-center justify-content-center me-3" 
                     style="width: 40px; height: 40px;">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div>
                    <h6 class="mb-0">{{ current_user.nickname }}</h6>
                    <small class="text-muted">${now}</small>
                </div>
            </div>
            ${tag ? `<span class="badge bg-secondary">${tag}</span>` : ''}
        </div>
        
        <h5 class="mb-3">${title}</h5>
        
        <div style="white-space: pre-wrap; line-height: 1.6;">
            ${content}
        </div>
        
        <hr class="my-4">
        
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex gap-3">
                <span class="text-muted"><i class="far fa-heart"></i> 0</span>
                <span class="text-muted"><i class="fas fa-comment"></i> 0</span>
                <span class="text-muted"><i class="fas fa-eye"></i> 0</span>
            </div>
            <small class="text-muted">ê²Œì‹œ í›„ ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

function submitPost() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
    modal.hide();
    
    setTimeout(() => {
        document.getElementById('postForm').dispatchEvent(new Event('submit'));
    }, 300);
}

function removeImage(index) {
    // ì´ë¯¸ì§€ ì œê±° ê¸°ëŠ¥ (ì¶”í›„ êµ¬í˜„)
    alert('ì´ë¯¸ì§€ ì œê±° ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// í˜ì´ì§€ ì´íƒˆ ë°©ì§€
window.addEventListener('beforeunload', function(e) {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;
    
    if (title.trim() || content.trim()) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}